name: Notify Review Request on Slack

on:
  pull_request:
    types: [review_requested]

jobs:
  notify-reviewer:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq (for safety)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_REVIEWER: ${{ github.event.requested_reviewer.login }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPOSITORY: ${{ github.repository }}
        run: |
          # GitHub ID ‚Üí Slack ID Îß§Ìïë
          declare -A GITHUB_TO_SLACK
          GITHUB_TO_SLACK["soeun2537"]="U09A0LM0CRW"
          GITHUB_TO_SLACK["taek2222"]="U099ARRH3D3"
          GITHUB_TO_SLACK["changuii"]="U099BR9RNE6"
          GITHUB_TO_SLACK["eoehd1ek"]="U0995NANDML"
          GITHUB_TO_SLACK["oungsi2000"]="U098U2R57NK"
          GITHUB_TO_SLACK["parkjiminnnn"]="U098U8SLXHD"
          GITHUB_TO_SLACK["etama123"]="U0995MPSZ62"

          # Slack Î©òÏÖò ID Ìï†Îãπ
          SLACK_AUTHOR_ID=${GITHUB_TO_SLACK[$PR_AUTHOR]}
          SLACK_REVIEWER_ID=${GITHUB_TO_SLACK[$PR_REVIEWER]}

          # Î¶¨Î∑∞ ÌûàÏä§ÌÜ†Î¶¨ Ï°∞Ìöå (Ïû¨ÏöîÏ≤≠ Ïó¨Î∂Ä ÌôïÏù∏)
          REVIEW_API_URL="https://api.github.com/repos/$REPOSITORY/pulls/$PR_NUMBER/reviews"
          REVIEW_COUNT=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
           "$REVIEW_API_URL" \
           | jq -r --arg reviewer "$PR_REVIEWER" '[.[] | select(.user.login == $reviewer)] | length')

          if [ "$REVIEW_COUNT" -gt 0 ]; then
           PR_STATUS="üè∏ *Î¶¨Î∑∞ Ïû¨ÏöîÏ≤≠ ÏïåÎ¶º*"
          else
           PR_STATUS="üì¢ *Î¶¨Î∑∞ ÏöîÏ≤≠ ÏïåÎ¶º*"
          fi
          
          curl -X POST \
            -H 'Content-type: application/json' \
            --data '{
              "text": "'"${PR_STATUS}"'\n*PR Ï†úÎ™©:* '"${PR_TITLE}"' (#'"${PR_NUMBER}"')\n*ÏûëÏÑ±Ïûê:* <@'"${SLACK_AUTHOR_ID}"'>\n*Î¶¨Î∑∞Ïñ¥:* <@'"${SLACK_REVIEWER_ID}"'>\n*ÎßÅÌÅ¨:* '"${PR_URL}"'"
            }' \
            $SLACK_WEBHOOK_URL
          
