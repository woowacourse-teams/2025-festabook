version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto21
    commands:
      - echo "📦 [Install Phase] 의존성 설치 시작"
      - cd backend
      - chmod +x ./gradlew
      - echo "✅ [Install Phase] 완료"

  pre_build:
    commands:
      - echo "⚙️ [Pre Build Phase] 환경파일 생성 시작"
      - mkdir -p src/main/resources/firebase
      - echo "$SECRET_YML" > src/main/resources/application-secret.yml
      - echo "$FIREBASE_ADMINSDK_ACCOUNT_KEY" > src/main/resources/firebase/firebase-adminsdk-account.json
      - echo "✅ [Pre Build Phase] 완료"

  build:
    commands:
      - echo "🚀 [Build Phase] Gradle 빌드 시작"
      - cd backend
      - ./gradlew clean build -x test
      - echo "✅ [Build Phase] 빌드 성공"

  post_build:
    commands:
      - echo "📤 [Post Build Phase] 산출물 패키징 시작"
      - cd backend
      - BUILD_JAR=$(find build/libs -name "*.jar" -not -name "*plain.jar" | head -n 1)
      - echo "🎯 Build JAR located at - $BUILD_JAR"
      - mkdir -p ../infra/output
      - cp "$BUILD_JAR" ../infra/output/
      - cp ../infra/appspec.yml ../infra/output/
      - cp -r ../infra/scripts ../infra/output/
      - echo "✅ [Post Build Phase] 산출물 패키징 완료"

artifacts:
  files:
    - backend/infra/output/**/*
